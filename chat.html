<!DOCTYPE html>
<html>
<head>
  <script src="https://www.gstatic.com/firebasejs/8.8.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.8.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.8.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.8.0/firebase-database.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <title>Chat - Big Cookie</title>
  <meta content="Chat - Big Cookie" property="og:title" />
  <meta content="big cookie" property="og:description" />
  <meta content="https://bigcookie.org" property="og:url" />
  <meta content="https://bigcookie.org/images/bigcookieOG.jpg" property="og:image" />
  <meta content="#43B581" data-react-helmet="true" name="theme-color" />
  <link href="/css/style.css" rel="stylesheet" type="text/css"/>
  <link href="favicon.png" rel="icon"/>
</head>
<body>
  <div class="navbar" id="myNavbar">
    <a href="index.html">Home</a>
    <a href="about.html">About</a>
    <a href="https://discord.gg/eKgZTtv87V" target="_blank">Discord</a>
    <a href="games.html">Games</a>
    <a href="http://play.bigcookie.org:7410" target="_blank">Map</a>
    <a href="javascript:void(0);" class="icon" onclick="myFunction()">
      <i class="fa fa-bars"></i>
    </a>
  </div>

  <h1>Big Cookie Chat</h1>

  <!-- Login Form -->
  <div id="loginDiv">
    <h2>Login</h2>
    <button class="btn" onclick="loginWithGoogle()">Login with Google <i class="fa-brands fa-google"></i></button>
    <p id="loginError" style="color: red;"></p>
  </div>

  <!-- Chat Room -->
  <div id="chatDiv" style="display: none;">
    <h2>Welcome to the Chat Room</h2>
    <div id="chatMessages"></div>
    <input class="message" type="text" id="messageField" placeholder="Type your message" /><br>
    <button class="btn" id="sendButton" onclick="sendMessage()">Send</button>
    <button class="btn" onclick="logout()">Logout</button>
    <p id="errorMessage" class="error" style="display: none;"></p>
  </div>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyCl8FoWIZ5y7xg2rYKngokJRkglfuMfGQE",
        authDomain: "big-cookie-login.firebaseapp.com",
        projectId: "big-cookie-login",
        storageBucket: "big-cookie-login.appspot.com",
        messagingSenderId: "491961115933",
        appId: "1:491961115933:web:a342e9957f4b1e960b6df4",
    };

    // Initialize Firebase with persistence enabled
    const firebaseApp = firebase.initializeApp(firebaseConfig);
    const auth = firebaseApp.auth();
    const database = firebaseApp.database();

    // Firebase references
    let messageRef;
    let isMessageListenerAttached = false;

    // Function to persist user's authentication state
    function persistAuthState(user) {
      if (user) {
        localStorage.setItem('chatAppUser', JSON.stringify(user));
      } else {
        localStorage.removeItem('chatAppUser');
      }
    }

    // Function to restore user's authentication state
    function restoreAuthState() {
      return new Promise((resolve, reject) => {
        const storedUser = localStorage.getItem('chatAppUser');
        if (storedUser) {
          const user = JSON.parse(storedUser);
          if (user && user.uid) {
            resolve(user);
          } else {
            resolve(null);
          }
        } else {
          resolve(null);
        }
      });
    }

    // Set local persistence for authentication
    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE)
    .then(() => {
      // Check if a user is logged in and restore the authentication state
      restoreAuthState()
      .then(user => {
        if (user) {
          // User is logged in
          firebase.auth().onAuthStateChanged(currentUser => {
            if (currentUser) {
              // User is still logged in
              persistAuthState(currentUser);
              listenForMessages();
            } else {
              // User is logged out
              clearChatMessages();
            }
          });
        } else {
          // User is logged out
          clearChatMessages();
        }
      })
      .catch(error => {
        console.log(error.message);
      });
  })
  .catch(error => {
    console.log(error.message);
  });

    // Login with Google function
    function loginWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();

      auth.signInWithPopup(provider)
        .then(result => {
          document.getElementById("loginDiv").style.display = "none";
          document.getElementById("chatDiv").style.display = "block";
          listenForMessages();
        })
        .catch(error => {
          document.getElementById("loginError").innerText = error.message;
        });
    }

    // Logout function
    function logout() {
      auth.signOut()
        .then(() => {
          document.getElementById("loginDiv").style.display = "block";
          document.getElementById("chatDiv").style.display = "none";
          document.getElementById("chatMessages").innerHTML = "";
        })
        .catch(error => {
          console.log(error.message);
        });
    }

    // Send message function
    function sendMessage() {
      const message = document.getElementById("messageField").value;
      const user = auth.currentUser;

      if (message && user) {
        if (message.length <= 256) {
        const messageData = {
          text: message,
          timestamp: Date.now(),
          userId: user.uid,
          userName: user.displayName
        };

        database.ref("messages").push(messageData)
          .then(() => {
            document.getElementById("messageField").value = "";
            document.getElementById("errorMessage").style.display = "none";
          })
          .catch(error => {
            cosole.log(error.message);
          });
        } else {
          document.getElementById("errorMessage").textContent = "Message should not exceed 256 characters.";
          document.getElementById("errorMessage").style.display = "block";
        }
      }
    }
    // Listen for new messages
    function listenForMessages() {
      if (!isMessageListenerAttached) {
        messageRef = database.ref("messages");
        
        messageRef.on("child_added", snapshot => {
          const messageData = snapshot.val();
          const chatMessages = document.getElementById("chatMessages");

          const messageElement = document.createElement("div");
          messageElement.textContent = `${messageData.userName}: ${messageData.text}`;

          chatMessages.appendChild(messageElement);

          // Scroll to the latest message
          chatMessages.scrollTop = chatMessages.scrollHeight;
        });
        
        isMessageListenerAttached = true;
      }
    }

    // Clear chat messages
    function clearChatMessages() {
      document.getElementById("chatMessages").innerHTML = "";
    }
  </script>
  <script src="/scripts/script.js"></script>
  <button class="toggle-dark-mode" onclick="toggleDarkMode()">Toggle Dark Mode</button>
</body>
</html>